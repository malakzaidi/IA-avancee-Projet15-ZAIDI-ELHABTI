{% extends "base.html" %}

{% block title %}Dashboard - Plateforme Médicale XAI{% endblock %}

{% block content %}
<div class="analysis-container">
    <!-- Header -->
    <div class="analysis-header">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="mb-1" style="color: var(--primary-color);">
                    <i class="fas fa-tachometer-alt me-2"></i> Dashboard Médical XAI
                </h2>
                <p class="text-muted mb-0">
                    Bienvenue, <strong>Dr. {{ user.full_name }}</strong> • {{ user.institution }}
                </p>
            </div>
            <div>
                <span class="badge bg-success me-2">
                    <i class="fas fa-check-circle me-1"></i> Modèle actif
                </span>
                <span class="badge bg-info">
                    <i class="fas fa-chart-line me-1"></i> {{ model_info.total_analyses }} analyses
                </span>
            </div>
        </div>

        <!-- Progress Steps -->
        <div class="analysis-steps">
            <div class="step active" data-step="1">
                <div class="step-number">1</div>
                <div class="step-label">Téléchargement</div>
            </div>
            <div class="step" data-step="2">
                <div class="step-number">2</div>
                <div class="step-label">Métadonnées</div>
            </div>
            <div class="step" data-step="3">
                <div class="step-number">3</div>
                <div class="step-label">Paramètres XAI</div>
            </div>
            <div class="step" data-step="4">
                <div class="step-number">4</div>
                <div class="step-label">Analyse & Résultats</div>
            </div>
        </div>
    </div>

    <!-- Error/Success Alerts -->
    <div id="errorAlert" class="alert alert-danger d-none" role="alert"></div>
    <div id="successAlert" class="alert alert-success d-none" role="alert"></div>

    <!-- Step 1: Upload -->
    <div id="step1" class="form-section active">
        <div class="row">
            <div class="col-lg-8">
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-cloud-upload-alt me-2"></i>
                            Étape 1 : Téléchargement de l'image
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="upload-zone" id="uploadZone">
                            <div class="upload-icon">
                                <i class="fas fa-file-image"></i>
                            </div>
                            <h4 class="mb-3">Glissez-déposez votre image dermatologique</h4>
                            <p class="text-muted mb-4">
                                ou cliquez pour sélectionner un fichier
                            </p>
                            <input type="file" id="fileInput" accept=".png,.jpg,.jpeg,.bmp" class="d-none">
                            <button type="button" class="btn-medical" onclick="document.getElementById('fileInput').click()">
                                <i class="fas fa-folder-open me-2"></i> Parcourir les fichiers
                            </button>
                            <p class="mt-3 small text-muted">
                                Formats supportés: PNG, JPG, JPEG, BMP • Max. 32MB
                            </p>
                        </div>

                        <div id="previewSection" class="mt-4 d-none">
                            <div class="preview-container">
                                <img id="imagePreview" class="preview-image" alt="Aperçu">
                                <div class="position-absolute top-0 end-0 p-3">
                                    <button type="button" class="btn btn-danger btn-sm" onclick="clearImage()">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="mt-3">
                                <p class="mb-1">
                                    <strong id="fileName"></strong>
                                    <span id="fileSize" class="text-muted ms-2"></span>
                                </p>
                                <div class="progress" style="height: 6px;">
                                    <div id="uploadProgress" class="progress-bar" role="progressbar" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <!-- Conseils techniques -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-lightbulb me-2"></i> Conseils techniques</h6>
                    </div>
                    <div class="card-body">
                        <ul class="mb-0 ps-3 small">
                            <li>Résolution recommandée: {{ model_info.img_size[0] }}×{{ model_info.img_size[1] }}</li>
                            <li>Évitez les reflets et ombres</li>
                            <li>Centrez la lésion dans l'image</li>
                            <li>Éclairage uniforme et diffus</li>
                            <li>Pas de filtre ou retouche</li>
                        </ul>
                    </div>
                </div>

                <!-- Informations modèle -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-brain me-2"></i> Modèle actuel</h6>
                    </div>
                    <div class="card-body">
                        <table class="table table-sm mb-0">
                            <tr><td><strong>Nom</strong></td><td>{{ model_info.name }}</td></tr>
                            <tr><td><strong>Statut</strong></td><td><span class="badge bg-success">{{ model_info.model_status }}</span></td></tr>
                            <tr><td><strong>Classes</strong></td><td>{{ classes|length }}</td></tr>
                            <tr><td><strong>Analyses</strong></td><td>{{ model_info.successful_analyses }}</td></tr>
                        </table>
                    </div>
                </div>

                <div class="d-grid gap-2">
                    <button type="button" class="btn-medical next-step" data-next="2" disabled id="nextStep1">
                        <i class="fas fa-arrow-right me-2"></i> Suivant → Métadonnées
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Step 2: Metadata -->
    <div id="step2" class="form-section">
        <div class="row">
            <div class="col-lg-8">
                <div class="card mb-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-user-injured me-2"></i>
                            Étape 2 : Informations cliniques
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="metadata-form">
                            <p class="text-muted mb-4">
                                Les métadonnées améliorent la précision du diagnostic en fournissant un contexte clinique.
                            </p>

                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="patientAge" class="form-label">Âge du patient *</label>
                                    <input type="number" class="form-control" id="patientAge"
                                           min="0" max="120" value="45" required>
                                    <div class="form-text">En années</div>
                                </div>

                                <div class="col-md-6">
                                    <label for="patientSex" class="form-label">Sexe *</label>
                                    <select class="form-select" id="patientSex" required>
                                        <option value="">Sélectionnez...</option>
                                        <option value="M">Masculin</option>
                                        <option value="F" selected>Féminin</option>
                                    </select>
                                </div>

                                <div class="col-md-6">
                                    <label for="localization" class="form-label">Localisation *</label>
                                    <select class="form-select" id="localization" required>
                                        <option value="">Sélectionnez...</option>
                                        <option value="0" selected>Tête/Visage</option>
                                        <option value="1">Torse</option>
                                        <option value="2">Membres supérieurs</option>
                                        <option value="3">Membres inférieurs</option>
                                        <option value="4">Mains/Pieds</option>
                                        <option value="5">Autre</option>
                                    </select>
                                </div>

                                <div class="col-md-6">
                                    <label for="skinType" class="form-label">Type de peau</label>
                                    <select class="form-select" id="skinType">
                                        <option value="">Non spécifié</option>
                                        <option value="1">Type I (toujours brûle)</option>
                                        <option value="2">Type II (brûle facilement)</option>
                                        <option value="3" selected>Type III (brûle modérément)</option>
                                        <option value="4">Type IV (bronze facilement)</option>
                                        <option value="5">Type V (rarement brûle)</option>
                                    </select>
                                </div>

                                <div class="col-12">
                                    <label for="clinicalNotes" class="form-label">Notes cliniques additionnelles</label>
                                    <textarea class="form-control" id="clinicalNotes" rows="4"
                                              placeholder="Antécédents familiaux, durée d'évolution, symptômes associés, traitements précédents..."></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <!-- Aide métadonnées -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i> Pourquoi ces informations ?</h6>
                    </div>
                    <div class="card-body">
                        <p class="small mb-0">
                            L'IA utilise ces informations pour contextualiser son diagnostic :
                            <br><br>
                            • <strong>Âge</strong> : Facteur de risque important pour plusieurs pathologies
                            <br>
                            • <strong>Sexe</strong> : Différences d'incidence selon le sexe
                            <br>
                            • <strong>Localisation</strong> : Localisation préférentielle selon les pathologies
                            <br>
                            • <strong>Type peau</strong> : Risque différentiel d'exposition solaire
                        </p>
                    </div>
                </div>

                <!-- Exemple LIME -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-chart-pie me-2"></i> Explication LIME</h6>
                    </div>
                    <div class="card-body">
                        <p class="small mb-0">
                            Les métadonnées seront analysées avec LIME pour montrer leur impact sur la décision.
                        </p>
                    </div>
                </div>

                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-outline-secondary prev-step" data-prev="1">
                        <i class="fas fa-arrow-left me-2"></i> Retour
                    </button>
                    <button type="button" class="btn-medical next-step" data-next="3">
                        <i class="fas fa-arrow-right me-2"></i> Suivant → Paramètres XAI
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Step 3: XAI Parameters -->
    <div id="step3" class="form-section">
        <div class="row">
            <div class="col-lg-8">
                <div class="card mb-4">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">
                            <i class="fas fa-sliders-h me-2"></i>
                            Étape 3 : Configuration XAI
                        </h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-4">
                            Configurez les méthodes d'explicabilité pour cette analyse.
                            <strong>Les paramètres par défaut sont recommandés.</strong>
                        </p>

                        <div class="xai-params">
                            <div class="row">
                                <!-- Méthode 1: Occlusion -->
                                <div class="col-md-6 mb-4">
                                    <div class="method-card method-occlusion p-3">
                                        <div class="d-flex align-items-center mb-3">
                                            <div class="method-icon me-3">
                                                <i class="fas fa-eye-slash fa-2x text-danger"></i>
                                            </div>
                                            <div>
                                                <h5 class="mb-1">Occlusion Sensitivity</h5>
                                                <small class="text-muted">Zones critiques</small>
                                            </div>
                                        </div>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="methodOcclusion" checked>
                                            <label class="form-check-label" for="methodOcclusion">
                                                Activer cette méthode
                                            </label>
                                        </div>
                                        <div class="mt-2">
                                            <label class="form-label small">Taille de patch</label>
                                            <input type="range" class="form-range" id="occlusionPatchSize" min="16" max="64" value="48" step="8">
                                            <div class="d-flex justify-content-between small">
                                                <span>16px</span>
                                                <span class="text-primary">48px</span>
                                                <span>64px</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Méthode 2: Integrated Gradients -->
                                <div class="col-md-6 mb-4">
                                    <div class="method-card method-ig p-3">
                                        <div class="d-flex align-items-center mb-3">
                                            <div class="method-icon me-3">
                                                <i class="fas fa-chart-line fa-2x text-primary"></i>
                                            </div>
                                            <div>
                                                <h5 class="mb-1">Gradients Intégrés</h5>
                                                <small class="text-muted">Attribution pixels</small>
                                            </div>
                                        </div>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="methodIG" checked>
                                            <label class="form-check-label" for="methodIG">
                                                Activer cette méthode
                                            </label>
                                        </div>
                                        <div class="mt-2">
                                            <label class="form-label small">Nombre d'étapes</label>
                                            <input type="range" class="form-range" id="igSteps" min="10" max="50" value="30" step="5">
                                            <div class="d-flex justify-content-between small">
                                                <span>10</span>
                                                <span class="text-primary">30</span>
                                                <span>50</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Méthode 3: Attention -->
                                <div class="col-md-6 mb-4">
                                    <div class="method-card method-attention p-3">
                                        <div class="d-flex align-items-center mb-3">
                                            <div class="method-icon me-3">
                                                <i class="fas fa-bullseye fa-2x text-success"></i>
                                            </div>
                                            <div>
                                                <h5 class="mb-1">Attention Rollout</h5>
                                                <small class="text-muted">Focus du modèle</small>
                                            </div>
                                        </div>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="methodAttention" checked>
                                            <label class="form-check-label" for="methodAttention">
                                                Activer cette méthode
                                            </label>
                                        </div>
                                        <div class="mt-2">
                                            <label class="form-label small">Flou gaussien (σ)</label>
                                            <input type="range" class="form-range" id="attentionBlur" min="5" max="20" value="10" step="1">
                                            <div class="d-flex justify-content-between small">
                                                <span>5</span>
                                                <span class="text-primary">10</span>
                                                <span>20</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Méthode 4: LIME -->
                                <div class="col-md-6 mb-4">
                                    <div class="method-card method-lime p-3">
                                        <div class="d-flex align-items-center mb-3">
                                            <div class="method-icon me-3">
                                                <i class="fas fa-chart-pie fa-2x text-purple"></i>
                                            </div>
                                            <div>
                                                <h5 class="mb-1">LIME Métadonnées</h5>
                                                <small class="text-muted">Explication clinique</small>
                                            </div>
                                        </div>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="methodLIME" checked>
                                            <label class="form-check-label" for="methodLIME">
                                                Activer cette méthode
                                            </label>
                                        </div>
                                        <div class="mt-2">
                                            <label class="form-label small">Échantillons LIME</label>
                                            <select class="form-select form-select-sm" id="limeSamples">
                                                <option value="100">100 (rapide)</option>
                                                <option value="300" selected>300 (standard)</option>
                                                <option value="500">500 (précis)</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <!-- Résumé des méthodes -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-project-diagram me-2"></i> Méthodes sélectionnées</h6>
                    </div>
                    <div class="card-body">
                        <ul class="list-group list-group-flush" id="selectedMethods">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Occlusion Sensitivity
                                <span class="badge bg-success"><i class="fas fa-check"></i></span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Gradients Intégrés
                                <span class="badge bg-success"><i class="fas fa-check"></i></span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Attention Rollout
                                <span class="badge bg-success"><i class="fas fa-check"></i></span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                LIME Métadonnées
                                <span class="badge bg-success"><i class="fas fa-check"></i></span>
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- Temps estimé -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-clock me-2"></i> Temps estimé</h6>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Analyse basique</span>
                            <span class="text-primary">~15s</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Méthodes XAI (3)</span>
                            <span class="text-primary">~30s</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span><strong>Total</strong></span>
                            <span class="text-success fw-bold">~45s</span>
                        </div>
                    </div>
                </div>

                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-outline-secondary prev-step" data-prev="2">
                        <i class="fas fa-arrow-left me-2"></i> Retour
                    </button>
                    <button type="button" class="btn-medical btn-medical-success next-step" data-next="4">
                        <i class="fas fa-play-circle me-2"></i> Lancer l'analyse complète
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Step 4: Analysis Results -->
    <div id="step4" class="form-section">
        <div class="row">
            <div class="col-lg-12">
                <!-- Chargement -->
                <div class="card mb-4" id="loadingSection">
                    <div class="card-body text-center py-5">
                        <div class="spinner-border text-primary mb-4" style="width: 4rem; height: 4rem;" role="status">
                            <span class="visually-hidden">Chargement...</span>
                        </div>
                        <h3 class="mb-3">Analyse XAI en cours...</h3>
                        <p class="text-muted mb-4">
                            Votre image est en cours d'analyse par notre système d'IA explicable multi-techniques.
                        </p>
                        <div class="progress mb-4" style="height: 10px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 45%"></div>
                        </div>
                        <div id="analysisStatus" class="small text-muted">
                            Initialisation du modèle...
                        </div>
                    </div>
                </div>

                <!-- Résultats (caché initialement) -->
                <div id="resultsSection" style="display: none;">
                    <!-- Section 1: Diagnostic principal -->
                    <div class="card mb-4" id="diagnosticCard">
                        <div class="card-header bg-dark text-white">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i class="fas fa-diagnoses me-2"></i>
                                    Résultat du Diagnostic
                                </h5>
                                <span class="badge bg-success" id="analysisBadge"></span>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-6">
                                    <h2 id="predictedClass" class="text-primary fw-bold mb-2"></h2>
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="me-3">
                                            <span class="fs-4 fw-bold" id="confidencePercent"></span>
                                            <span class="text-muted"> confiance</span>
                                        </div>
                                        <div id="confidenceBadge"></div>
                                    </div>
                                    <div id="confidenceProgress" class="mb-3"></div>
                                </div>
                                <div class="col-md-6">
                                    <div id="consensusPanel" class="p-3 rounded" style="background: #f8f9fa;">
                                        <h6><i class="fas fa-handshake me-2"></i> Validation XAI</h6>
                                        <div id="consensusBadge" class="mb-2"></div>
                                        <small class="text-muted" id="consensusDetails"></small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section 2: Dashboard XAI complet -->
                    <div class="card mb-4">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-tachometer-alt me-2"></i>
                                Dashboard XAI Multi-Techniques
                            </h5>
                        </div>
                        <div class="card-body text-center">
                            <img id="dashboardImage" class="img-fluid rounded shadow"
                                 alt="Dashboard XAI Multi-Techniques" style="max-width: 100%;">
                            <p class="text-muted mt-3">
                                <i class="fas fa-info-circle me-1"></i>
                                Synthèse des 3 méthodes XAI + métriques de confiance
                            </p>
                        </div>
                    </div>

                    <!-- Section 3: Corrélations entre méthodes -->
                    <div class="card mb-4" id="correlationSection" style="display: none;">
                        <div class="card-header bg-secondary text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-project-diagram me-2"></i>
                                Corrélations entre Méthodes XAI
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="p-3 rounded bg-light">
                                        <h6><i class="fas fa-chart-line me-2"></i> Matrice de corrélation</h6>
                                        <div id="correlationMatrixViz"></div>
                                        <div class="mt-3">
                                            <p class="small text-muted">
                                                <i class="fas fa-info-circle me-1"></i>
                                                Les corrélations mesurent l'accord entre les différentes méthodes XAI.
                                                Une corrélation élevée (>0.7) indique un fort consensus.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="p-3 rounded bg-light">
                                        <h6><i class="fas fa-chart-bar me-2"></i> Métriques de consensus</h6>
                                        <div id="consensusMetrics"></div>
                                        <div class="mt-3">
                                            <div class="alert alert-info small">
                                                <i class="fas fa-lightbulb me-2"></i>
                                                <strong>Interprétation :</strong> Un consensus fort (>0.8) entre les méthodes
                                                augmente la confiance dans les explications générées.
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section 4: Autres résultats -->
                    <div class="row">
                        <div class="col-lg-4">
                            <!-- Rapport PDF -->
                            <div class="card mb-4" id="pdfSection" style="display: none;">
                                <div class="card-body text-center">
                                    <i class="fas fa-file-pdf fa-3x text-danger mb-3"></i>
                                    <h5>Rapport PDF</h5>
                                    <p class="small text-muted">Rapport médical complet généré</p>
                                    <a id="pdfDownloadBtn" class="btn btn-outline-danger btn-sm" target="_blank">
                                        <i class="fas fa-download me-2"></i>
                                        Télécharger
                                    </a>
                                </div>
                            </div>

                            <!-- Métadonnées LIME -->
                            <div class="card mb-4" id="limeSection" style="display: none;">
                                <div class="card-body text-center">
                                    <i class="fas fa-chart-pie fa-3x text-purple mb-3"></i>
                                    <h5>Analyse LIME</h5>
                                    <p class="small text-muted">Impact des métadonnées</p>
                                    <button class="btn btn-outline-purple btn-sm" onclick="toggleLIME()">
                                        <i class="fas fa-eye me-2"></i>
                                        Afficher
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-8">
                            <!-- Images détaillées -->
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="fas fa-images me-2"></i>
                                        Visualisations 2D Détaillées
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <h6>Image Originale</h6>
                                            <img id="originalImage" class="img-fluid rounded shadow-sm">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <h6>Consensus XAI</h6>
                                            <img id="consensusImage" class="img-fluid rounded shadow-sm">
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <h6 class="small">Occlusion</h6>
                                            <img id="occlusionImage" class="img-fluid rounded">
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <h6 class="small">Gradients Intégrés</h6>
                                            <img id="igImage" class="img-fluid rounded">
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <h6 class="small">Attention</h6>
                                            <img id="attentionImage" class="img-fluid rounded">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Boutons d'action -->
                    <div class="text-center mb-5">
                        <button type="button" class="btn-medical me-3" onclick="goToStep(1)">
                            <i class="fas fa-redo me-2"></i> Nouvelle analyse
                        </button>
                        <a href="{{ url_for('analysis_history') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-history me-2"></i> Voir l'historique
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
        <div class="spinner-border spinner-large text-primary" role="status">
            <span class="visually-hidden">Chargement...</span>
        </div>
        <h3 class="mt-4 mb-3">Analyse XAI en cours</h3>
        <p class="text-muted mb-4" id="loadingMessage">
            Initialisation du système multi-techniques...
        </p>
        <div class="progress mb-4" style="height: 6px;">
            <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 100%"></div>
        </div>
        <div class="small text-muted" id="loadingDetails">
            Cette analyse utilise 4 méthodes d'explicabilité.
        </div>
    </div>
</div>

<style>
:root {
    --primary-color: #2c3e50;
    --secondary-color: #3498db;
    --accent-color: #27ae60;
    --warning-color: #f39c12;
    --danger-color: #e74c3c;
    --purple-color: #9b59b6;
    --light-bg: #f8f9fa;
}

.analysis-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
}

.analysis-header {
    background: white;
    border-radius: 15px;
    padding: 25px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    margin-bottom: 25px;
}

.analysis-steps {
    display: flex;
    justify-content: space-between;
    margin-top: 30px;
    position: relative;
}

.analysis-steps:before {
    content: '';
    position: absolute;
    top: 20px;
    left: 0;
    width: 100%;
    height: 2px;
    background: #e9ecef;
    z-index: 1;
}

.step {
    position: relative;
    z-index: 2;
    text-align: center;
    flex: 1;
}

.step-number {
    width: 40px;
    height: 40px;
    background: #e9ecef;
    color: #6c757d;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 10px;
    font-weight: bold;
    font-size: 1.1rem;
    border: 3px solid white;
    transition: all 0.3s ease;
}

.step.active .step-number {
    background: var(--secondary-color);
    color: white;
    transform: scale(1.1);
    box-shadow: 0 0 0 5px rgba(52, 152, 219, 0.2);
}

.step.completed .step-number {
    background: var(--accent-color);
    color: white;
}

.step-label {
    font-weight: 600;
    color: #6c757d;
    transition: all 0.3s ease;
}

.step.active .step-label {
    color: var(--primary-color);
    font-weight: 700;
}

.upload-zone {
    border: 3px dashed #dee2e6;
    border-radius: 15px;
    padding: 50px 30px;
    text-align: center;
    background: white;
    cursor: pointer;
    transition: all 0.3s ease;
}

.upload-zone:hover {
    border-color: var(--secondary-color);
    background: #f8f9fa;
}

.upload-zone.dragover {
    border-color: var(--accent-color);
    background: #f0fff4;
}

.upload-icon {
    font-size: 4rem;
    color: #dee2e6;
    margin-bottom: 20px;
    transition: all 0.3s ease;
}

.upload-zone:hover .upload-icon {
    color: var(--secondary-color);
}

.preview-container {
    position: relative;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.preview-image {
    width: 100%;
    height: 300px;
    object-fit: cover;
}

.metadata-form .form-control, .metadata-form .form-select {
    padding: 12px 15px;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    font-size: 1rem;
    transition: all 0.3s ease;
}

.metadata-form .form-control:focus, .metadata-form .form-select:focus {
    border-color: var(--secondary-color);
    box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
}

.btn-medical {
    background: var(--secondary-color);
    color: white;
    padding: 12px 30px;
    border-radius: 8px;
    font-weight: 600;
    border: none;
    transition: all 0.3s ease;
}

.btn-medical:hover {
    background: #2980b9;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.btn-medical-success {
    background: var(--accent-color);
}

.btn-medical-success:hover {
    background: #219653;
}

.btn-medical-warning {
    background: var(--warning-color);
}

.btn-outline-purple {
    border: 2px solid var(--purple-color);
    color: var(--purple-color);
}

.btn-outline-purple:hover {
    background: var(--purple-color);
    color: white;
}

.method-card {
    border: 2px solid #e9ecef;
    border-radius: 12px;
    background: white;
    transition: all 0.3s ease;
    height: 100%;
}

.method-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 15px rgba(0,0,0,0.1);
}

.method-occlusion {
    border-top: 4px solid var(--danger-color);
}

.method-ig {
    border-top: 4px solid var(--secondary-color);
}

.method-attention {
    border-top: 4px solid var(--accent-color);
}

.method-lime {
    border-top: 4px solid var(--purple-color);
}

.method-icon {
    width: 50px;
    height: 50px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.method-occlusion .method-icon {
    background: rgba(231, 76, 60, 0.1);
}

.method-ig .method-icon {
    background: rgba(52, 152, 219, 0.1);
}

.method-attention .method-icon {
    background: rgba(39, 174, 96, 0.1);
}

.method-lime .method-icon {
    background: rgba(155, 89, 182, 0.1);
}

.form-section {
    display: none;
    animation: fadeIn 0.5s ease;
}

.form-section.active {
    display: block;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.85);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}

.loading-content {
    background: white;
    padding: 40px;
    border-radius: 15px;
    text-align: center;
    max-width: 500px;
    width: 90%;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

.spinner-large {
    width: 80px;
    height: 80px;
    margin: 0 auto 20px;
}

.xai-params {
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    border-radius: 12px;
    padding: 25px;
}

.form-check-input:checked {
    background-color: var(--secondary-color);
    border-color: var(--secondary-color);
}

.form-range::-webkit-slider-thumb {
    background: var(--secondary-color);
}

.form-range::-moz-range-thumb {
    background: var(--secondary-color);
}

@media (max-width: 768px) {
    .analysis-steps {
        flex-direction: column;
        gap: 20px;
    }

    .analysis-steps:before {
        display: none;
    }

    .step {
        display: flex;
        align-items: center;
        gap: 15px;
        text-align: left;
    }

    .step-number {
        margin: 0;
        flex-shrink: 0;
    }
}
</style>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

<script>
let currentStep = 1;
let selectedFile = null;
let imageUrl = null;
let analysisResult = null;

document.addEventListener('DOMContentLoaded', function() {
    initStepNavigation();
    initFileUpload();
    initMethodSwitches();
    initRangeInputs();
});

function initStepNavigation() {
    document.querySelectorAll('.next-step').forEach(btn => {
        btn.addEventListener('click', function() {
            const nextStep = parseInt(this.dataset.next);

            if (validateStep(currentStep)) {
                goToStep(nextStep);

                if (nextStep === 4) {
                    startAnalysis();
                }
            }
        });
    });

    document.querySelectorAll('.prev-step').forEach(btn => {
        btn.addEventListener('click', function() {
            const prevStep = parseInt(this.dataset.prev);
            goToStep(prevStep);
        });
    });
}

function validateStep(step) {
    switch(step) {
        case 1:
            if (!selectedFile) {
                showError('Veuillez sélectionner une image dermatologique');
                return false;
            }
            return true;

        case 2:
            const age = document.getElementById('patientAge').value;
            const sex = document.getElementById('patientSex').value;
            const localization = document.getElementById('localization').value;

            if (!age || !sex || !localization) {
                showError('Veuillez remplir tous les champs obligatoires (âge, sexe, localisation)');
                return false;
            }
            return true;

        default:
            return true;
    }
}

function goToStep(step) {
    document.querySelectorAll('.form-section').forEach(section => {
        section.classList.remove('active');
    });

    document.getElementById(`step${step}`).classList.add('active');

    document.querySelectorAll('.step').forEach(stepEl => {
        const stepNum = parseInt(stepEl.dataset.step);
        stepEl.classList.remove('active', 'completed');

        if (stepNum < step) {
            stepEl.classList.add('completed');
        } else if (stepNum === step) {
            stepEl.classList.add('active');
        }
    });

    currentStep = step;

    // Scroll vers le haut quand on change d'étape
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function initFileUpload() {
    const uploadZone = document.getElementById('uploadZone');
    const fileInput = document.getElementById('fileInput');
    const previewSection = document.getElementById('previewSection');
    const imagePreview = document.getElementById('imagePreview');
    const nextStepBtn = document.getElementById('nextStep1');

    uploadZone.addEventListener('click', function(e) {
        if (e.target !== fileInput) {
            fileInput.click();
        }
    });

    uploadZone.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadZone.classList.add('dragover');
    });

    uploadZone.addEventListener('dragleave', function() {
        uploadZone.classList.remove('dragover');
    });

    uploadZone.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadZone.classList.remove('dragover');

        if (e.dataTransfer.files.length > 0) {
            handleFile(e.dataTransfer.files[0]);
        }
    });

    fileInput.addEventListener('change', function() {
        if (this.files.length > 0) {
            handleFile(this.files[0]);
        }
    });

    function handleFile(file) {
        const validTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/bmp'];
        const maxSize = 32 * 1024 * 1024;

        if (!validTypes.includes(file.type)) {
            showError('Format de fichier non supporté. Utilisez PNG, JPG ou JPEG.');
            return;
        }

        if (file.size > maxSize) {
            showError('Fichier trop volumineux. Maximum 32MB.');
            return;
        }

        selectedFile = file;

        const reader = new FileReader();
        reader.onload = function(e) {
            imageUrl = e.target.result;
            imagePreview.src = imageUrl;
            previewSection.classList.remove('d-none');

            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent =
                `(${(file.size / 1024 / 1024).toFixed(2)} MB)`;

            // Animation de progression
            let progress = 0;
            const progressBar = document.getElementById('uploadProgress');
            progressBar.classList.add('progress-bar-animated');

            const interval = setInterval(() => {
                progress += 5;
                progressBar.style.width = `${progress}%`;

                if (progress >= 100) {
                    clearInterval(interval);
                    nextStepBtn.disabled = false;
                    progressBar.classList.remove('progress-bar-animated');
                    progressBar.classList.add('bg-success');

                    // Petit effet visuel
                    setTimeout(() => {
                        progressBar.style.transition = 'all 0.3s ease';
                        progressBar.style.boxShadow = '0 0 10px rgba(39, 174, 96, 0.5)';
                        setTimeout(() => {
                            progressBar.style.boxShadow = 'none';
                        }, 1000);
                    }, 300);
                }
            }, 50);
        };
        reader.readAsDataURL(file);
    }
}

function clearImage() {
    selectedFile = null;
    imageUrl = null;
    document.getElementById('fileInput').value = '';
    document.getElementById('previewSection').classList.add('d-none');
    document.getElementById('nextStep1').disabled = true;
    document.getElementById('uploadProgress').style.width = '0%';
    document.getElementById('uploadProgress').classList.remove('bg-success');
    document.getElementById('uploadProgress').classList.add('progress-bar-animated');
}

function initMethodSwitches() {
    const switches = ['methodOcclusion', 'methodIG', 'methodAttention', 'methodLIME'];

    switches.forEach(switchId => {
        const switchEl = document.getElementById(switchId);
        if (switchEl) {
            switchEl.addEventListener('change', updateSelectedMethods);
        }
    });

    updateSelectedMethods();
}

function updateSelectedMethods() {
    const methodsList = document.getElementById('selectedMethods');
    if (!methodsList) return;

    const methods = [
        { id: 'methodOcclusion', name: 'Occlusion Sensitivity', default: true },
        { id: 'methodIG', name: 'Gradients Intégrés', default: true },
        { id: 'methodAttention', name: 'Attention Rollout', default: true },
        { id: 'methodLIME', name: 'LIME Métadonnées', default: true }
    ];

    methodsList.innerHTML = '';

    methods.forEach(method => {
        const isEnabled = document.getElementById(method.id)?.checked ?? method.default;

        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center';

        const nameSpan = document.createElement('span');
        nameSpan.textContent = method.name;
        if (!isEnabled) {
            nameSpan.style.textDecoration = 'line-through';
            nameSpan.style.color = '#6c757d';
        }

        const badge = document.createElement('span');
        badge.className = isEnabled ? 'badge bg-success' : 'badge bg-secondary';
        badge.innerHTML = isEnabled ? '<i class="fas fa-check"></i>' : '<i class="fas fa-times"></i>';

        li.appendChild(nameSpan);
        li.appendChild(badge);
        methodsList.appendChild(li);
    });
}

function initRangeInputs() {
    const ranges = ['occlusionPatchSize', 'igSteps', 'attentionBlur'];

    ranges.forEach(rangeId => {
        const rangeEl = document.getElementById(rangeId);
        if (rangeEl) {
            rangeEl.addEventListener('input', function() {
                const valueSpan = this.parentElement.querySelector('.text-primary');
                if (valueSpan) {
                    valueSpan.textContent = `${this.value}${rangeId === 'attentionBlur' ? '' : 'px'}`;
                }
            });
        }
    });
}

async function startAnalysis() {
    const loadingOverlay = document.getElementById('loadingOverlay');
    const loadingMessage = document.getElementById('loadingMessage');
    const loadingDetails = document.getElementById('loadingDetails');
    const analysisStatus = document.getElementById('analysisStatus');

    loadingOverlay.style.display = 'flex';

    console.log('🚀 Démarrage de l\'analyse XAI multi-techniques...');

    try {
        if (!selectedFile || !(selectedFile instanceof File)) {
            throw new Error('Aucun fichier image sélectionné');
        }

        const formData = new FormData();
        formData.append('file', selectedFile);

        // Métadonnées
        formData.append('age', document.getElementById('patientAge').value);
        formData.append('sex', document.getElementById('patientSex').value);
        formData.append('localization', document.getElementById('localization').value);

        const skinType = document.getElementById('skinType').value;
        if (skinType) {
            formData.append('skin_type', skinType);
        }

        const notes = document.getElementById('clinicalNotes').value;
        if (notes) {
            formData.append('clinical_notes', notes);
        }

        // Paramètres XAI
        const xaiParams = {
            enable_occlusion: document.getElementById('methodOcclusion').checked,
            occlusion_patch_size: document.getElementById('occlusionPatchSize').value,
            enable_ig: document.getElementById('methodIG').checked,
            ig_steps: document.getElementById('igSteps').value,
            enable_attention: document.getElementById('methodAttention').checked,
            attention_blur: document.getElementById('attentionBlur').value,
            enable_lime: document.getElementById('methodLIME').checked,
            lime_samples: document.getElementById('limeSamples').value
        };

        formData.append('xai_params', JSON.stringify(xaiParams));

        // Messages de progression
        const messages = [
            { msg: 'Chargement du modèle DenseNet...', time: 2000 },
            { msg: 'Prétraitement de l\'image...', time: 3000 },
            { msg: 'Calcul des prédictions principales...', time: 4000 },
            { msg: 'Génération des explications XAI...', time: 6000 },
            { msg: 'Occlusion Sensitivity en cours...', time: 3000 },
            { msg: 'Calcul des Gradients Intégrés...', time: 4000 },
            { msg: 'Génération de l\'Attention Rollout...', time: 3000 },
            { msg: 'Analyse LIME des métadonnées...', time: 4000 },
            { msg: 'Calcul des corrélations entre méthodes...', time: 3000 },
            { msg: 'Génération du rapport PDF médical...', time: 3000 },
            { msg: 'Finalisation de l\'analyse...', time: 2000 }
        ];

        let msgIndex = 0;
        const messageInterval = setInterval(() => {
            if (msgIndex < messages.length) {
                loadingMessage.textContent = messages[msgIndex].msg;
                loadingDetails.textContent = `Étape ${msgIndex + 1}/${messages.length} • Temps estimé restant: ${Math.round((messages.length - msgIndex) * 3)}s`;

                // Mettre à jour la barre de progression
                const progress = ((msgIndex + 1) / messages.length) * 100;
                if (analysisStatus) {
                    analysisStatus.textContent = `${Math.round(progress)}% complet • ${messages[msgIndex].msg}`;
                }

                msgIndex++;
            }
        }, 2000);

        console.log('📤 Envoi de la requête d\'analyse XAI...');

        const response = await fetch('/api/predict_ultimate', {
            method: 'POST',
            body: formData
        });

        clearInterval(messageInterval);

        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Erreur HTTP ${response.status}: ${errorText}`);
        }

        const result = await response.json();
        console.log('✅ Résultat reçu:', result);

        if (result.success === false) {
            throw new Error(result.error || 'Erreur lors de l\'analyse XAI');
        }

        if (!result.analysis_id) {
            throw new Error('ID d\'analyse manquant dans la réponse');
        }

        analysisResult = result;

        loadingMessage.textContent = 'Analyse terminée ! Affichage des résultats...';
        loadingDetails.textContent = 'Génération des visualisations...';

        // Attendre 2 secondes puis afficher les résultats
        setTimeout(() => {
            loadingOverlay.style.display = 'none';
            displayResults(result);
        }, 2000);

    } catch (error) {
        console.error('❌ Erreur lors de l\'analyse:', error);
        loadingOverlay.style.display = 'none';

        showError(`Erreur d'analyse XAI: ${error.message}\n\nConsultez la console (F12) pour plus de détails.`);
        goToStep(1);
    }
}

function displayResults(data) {
    console.log('📊 Affichage des résultats:', data);

    // Cacher la section de chargement, montrer les résultats
    document.getElementById('loadingSection').style.display = 'none';
    document.getElementById('resultsSection').style.display = 'block';

    // 1. Diagnostic principal
    document.getElementById('predictedClass').textContent = data.predicted_class;
    document.getElementById('confidencePercent').textContent = data.confidence_percent;
    document.getElementById('analysisBadge').textContent = `Analyse #${data.analysis_id}`;

    const confidence = data.confidence;
    let confidenceBadge = '';
    let confidenceColor = '';

    if (confidence > 0.8) {
        confidenceBadge = '<span class="badge bg-success">TRÈS ÉLEVÉE</span>';
        confidenceColor = 'success';
    } else if (confidence > 0.6) {
        confidenceBadge = '<span class="badge bg-warning">ÉLEVÉE</span>';
        confidenceColor = 'warning';
    } else {
        confidenceBadge = '<span class="badge bg-secondary">MODÉRÉE</span>';
        confidenceColor = 'secondary';
    }

    document.getElementById('confidenceBadge').innerHTML = confidenceBadge;
    document.getElementById('confidenceProgress').innerHTML = `
        <div class="progress" style="height: 20px;">
            <div class="progress-bar bg-${confidenceColor}"
                 role="progressbar" style="width: ${data.confidence * 100}%">
                ${data.confidence_percent}
            </div>
        </div>
    `;

    // 2. Métriques de confiance XAI
    const confMetrics = data.confidence_metrics;
    if (confMetrics) {
        const confidenceLevel = confMetrics.confidence_level;
        const confidenceColorXAI = confMetrics.confidence_color;

        document.getElementById('consensusBadge').innerHTML = `
            <span class="badge bg-${confidenceColorXAI}">${confidenceLevel}</span>
            <span class="badge bg-info ms-2">Consensus: ${confMetrics.consensus_strength?.toFixed(2) || 'N/A'}</span>
            <span class="badge bg-secondary ms-2">Accord: ${confMetrics.avg_agreement?.toFixed(2) || 'N/A'}</span>
        `;

        document.getElementById('consensusDetails').textContent =
            `Sparsité: ${confMetrics.sparsity?.toFixed(2) || 'N/A'} • Score composite: ${confMetrics.confidence_score?.toFixed(2) || 'N/A'}`;

        // Mettre à jour la couleur de la carte diagnostic
        const diagnosticCard = document.getElementById('diagnosticCard');
        diagnosticCard.className = diagnosticCard.className.replace(/border-\w+/g, '');
        diagnosticCard.classList.add(`border-${confidenceColorXAI}`, `border-3`);
    }

    // 3. Dashboard principal
    if (data.dashboard_complete) {
        document.getElementById('dashboardImage').src = 'data:image/png;base64,' + data.dashboard_complete;
    }

    // 4. Corrélations entre méthodes
    if (data.xai_metrics?.correlations) {
        document.getElementById('correlationSection').style.display = 'block';
        displayCorrelationMatrix(data.xai_metrics.correlations, data.confidence_metrics);
    }

    // 5. Rapport PDF
    if (data.pdf_report_url) {
        document.getElementById('pdfSection').style.display = 'block';
        document.getElementById('pdfDownloadBtn').href = data.pdf_report_url;
    }

    // 6. LIME
    if (data.lime_metadata) {
        document.getElementById('limeSection').style.display = 'block';
    }

    // 7. Images détaillées
    if (data.original_image) {
        document.getElementById('originalImage').src = 'data:image/png;base64,' + data.original_image;
    }
    if (data.overlay_occlusion) {
        document.getElementById('occlusionImage').src = 'data:image/png;base64,' + data.overlay_occlusion;
    }
    if (data.overlay_integrated_gradients) {
        document.getElementById('igImage').src = 'data:image/png;base64,' + data.overlay_integrated_gradients;
    }
    if (data.overlay_attention) {
        document.getElementById('attentionImage').src = 'data:image/png;base64,' + data.overlay_attention;
    }
    if (data.overlay_consensus) {
        document.getElementById('consensusImage').src = 'data:image/png;base64,' + data.overlay_consensus;
    }

    // Scroll vers les résultats
    setTimeout(() => {
        document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
    }, 500);
}

function displayCorrelationMatrix(correlations, confidenceMetrics) {
    if (!correlations) return;

    const matrixContainer = document.getElementById('correlationMatrixViz');
    const metricsContainer = document.getElementById('consensusMetrics');

    // Matrice de corrélation
    const methods = ['Occlusion', 'Gradients', 'Attention'];
    let matrixHTML = `
        <div class="table-responsive">
            <table class="table table-bordered table-sm text-center">
                <thead>
                    <tr>
                        <th></th>
                        <th>Occlusion</th>
                        <th>Gradients</th>
                        <th>Attention</th>
                    </tr>
                </thead>
                <tbody>
    `;

    for (let i = 0; i < methods.length; i++) {
        matrixHTML += `<tr><th>${methods[i]}</th>`;
        for (let j = 0; j < methods.length; j++) {
            let correlation = 0;
            if (i === j) {
                correlation = 1.0;
            } else if (i === 0 && j === 1) {
                correlation = correlations.occ_ig || 0;
            } else if (i === 0 && j === 2) {
                correlation = correlations.occ_att || 0;
            } else if (i === 1 && j === 2) {
                correlation = correlations.ig_att || 0;
            } else {
                correlation = correlations[`${methods[j].toLowerCase()}_${methods[i].toLowerCase()}`] || 0;
            }

            let colorClass = '';
            if (correlation > 0.7) colorClass = 'bg-success text-white';
            else if (correlation > 0.3) colorClass = 'bg-warning';
            else colorClass = 'bg-danger text-white';

            matrixHTML += `<td class="${colorClass} fw-bold">${correlation.toFixed(2)}</td>`;
        }
        matrixHTML += '</tr>';
    }

    matrixHTML += '</tbody></table></div>';
    matrixContainer.innerHTML = matrixHTML;

    // Métriques de consensus
    if (confidenceMetrics) {
        let metricsHTML = `
            <div class="mb-3">
                <div class="d-flex justify-content-between mb-1">
                    <span>Force du consensus</span>
                    <span class="fw-bold">${confidenceMetrics.consensus_strength?.toFixed(2) || '0.00'}</span>
                </div>
                <div class="progress" style="height: 10px;">
                    <div class="progress-bar bg-success" style="width: ${(confidenceMetrics.consensus_strength || 0) * 100}%"></div>
                </div>
            </div>
            <div class="mb-3">
                <div class="d-flex justify-content-between mb-1">
                    <span>Accord moyen</span>
                    <span class="fw-bold">${confidenceMetrics.avg_agreement?.toFixed(2) || '0.00'}</span>
                </div>
                <div class="progress" style="height: 10px;">
                    <div class="progress-bar bg-info" style="width: ${(confidenceMetrics.avg_agreement || 0) * 100}%"></div>
                </div>
            </div>
            <div class="mb-3">
                <div class="d-flex justify-content-between mb-1">
                    <span>Sparsité</span>
                    <span class="fw-bold">${confidenceMetrics.sparsity?.toFixed(2) || '0.00'}</span>
                </div>
                <div class="progress" style="height: 10px;">
                    <div class="progress-bar bg-primary" style="width: ${(confidenceMetrics.sparsity || 0) * 100}%"></div>
                </div>
            </div>
            <div class="mb-3">
                <div class="d-flex justify-content-between mb-1">
                    <span>Score de confiance</span>
                    <span class="fw-bold">${confidenceMetrics.confidence_score?.toFixed(2) || '0.00'}</span>
                </div>
                <div class="progress" style="height: 10px;">
                    <div class="progress-bar bg-warning" style="width: ${(confidenceMetrics.confidence_score || 0) * 100}%"></div>
                </div>
            </div>
        `;
        metricsContainer.innerHTML = metricsHTML;
    }
}

function toggleLIME() {
    if (analysisResult?.lime_metadata) {
        // Ouvrir une modale avec l'image LIME
        const limeModal = new bootstrap.Modal(document.createElement('div'));
        const modalHTML = `
            <div class="modal fade" id="limeModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title"><i class="fas fa-chart-pie me-2"></i> Analyse LIME des Métadonnées</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <img src="data:image/png;base64,${analysisResult.lime_metadata}" class="img-fluid">
                                </div>
                                <div class="col-md-4">
                                    <h6>Interprétation</h6>
                                    <pre class="p-3 bg-light rounded small">${analysisResult.lime_interpretation || 'Analyse des contributions des métadonnées au diagnostic.'}</pre>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHTML);
        const modalElement = document.getElementById('limeModal');
        const modal = new bootstrap.Modal(modalElement);
        modal.show();

        modalElement.addEventListener('hidden.bs.modal', function() {
            modalElement.remove();
        });
    }
}

function showError(message) {
    const alert = document.getElementById('errorAlert');
    alert.textContent = message;
    alert.classList.remove('d-none');

    setTimeout(() => {
        alert.classList.add('d-none');
    }, 8000);

    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function showSuccess(message) {
    const alert = document.getElementById('successAlert');
    alert.textContent = message;
    alert.classList.remove('d-none');

    setTimeout(() => {
        alert.classList.add('d-none');
    }, 3000);
}
</script>
{% endblock %}